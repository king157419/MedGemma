pub fn format_summary(result : @types.AnalysisResult) -> String {
  let mut output = "ã€å¥åº·æŠ¥å‘Šè§£è¯»ã€‘\n"
  output = output + "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
  
  output = output + "ğŸ“‹ æ•´ä½“è¯„ä¼°ï¼š\n"
  output = output + result.summary + "\n\n"
  
  if result.details.length() > 0 {
    output = output + "ğŸ“Š è¯¦ç»†æŒ‡æ ‡åˆ†æï¼š\n"
    output = output + "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    for item in result.details {
      output = output + format_detail_item(item)
    }
    output = output + "\n"
  }
  
  if result.warnings.length() > 0 {
    output = output + "âš ï¸ éœ€è¦å…³æ³¨çš„æŒ‡æ ‡ï¼š\n"
    for warning in result.warnings {
      output = output + "  â€¢ " + warning + "\n"
    }
    output = output + "\n"
  }
  
  if result.recommendations.length() > 0 {
    output = output + "ğŸ’¡ å»ºè®®ï¼š\n"
    for rec in result.recommendations {
      output = output + "  â€¢ " + rec + "\n"
    }
    output = output + "\n"
  }
  
  output = output + "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
  output = output + "ğŸ“Œ é‡è¦æç¤ºï¼šæœ¬è§£è¯»ä»…ä¾›å‚è€ƒï¼Œä¸ä½œä¸ºåŒ»ç–—è¯Šæ–­ä¾æ®ã€‚\n"
  output = output + "   å¦‚æœ‰å¥åº·é—®é¢˜ï¼Œè¯·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿã€‚\n"
  
  output
}

fn format_detail_item(item : @types.DetailItem) -> String {
  let status_icon = match item.status {
    @types.ItemStatus::Normal => "âœ…"
    @types.ItemStatus::High => "â¬†ï¸"
    @types.ItemStatus::Low => "â¬‡ï¸"
    @types.ItemStatus::Abnormal => "âš ï¸"
    @types.ItemStatus::Unknown => "â“"
  }
  
  let mut output = "\n" + status_icon + " " + item.item_name + "\n"
  output = output + "   æ£€æµ‹å€¼ï¼š" + item.value + " " + item.unit + "\n"
  if !item.normal_range.is_empty() {
    output = output + "   æ­£å¸¸èŒƒå›´ï¼š" + item.normal_range + "\n"
  }
  if !item.explanation.is_empty() {
    output = output + "   è§£è¯»ï¼š" + item.explanation + "\n"
  }
  output
}

pub fn format_json(result : @types.AnalysisResult) -> String {
  let json_obj = #{
    "summary": result.summary,
    "details": result.details.map(|item| #{
      "name": item.item_name,
      "value": item.value,
      "unit": item.unit,
      "normal_range": item.normal_range,
      "status": status_to_string(item.status),
      "explanation": item.explanation
    }),
    "warnings": result.warnings,
    "recommendations": result.recommendations,
    "confidence": result.confidence
  }
  json_obj.to_json()
}

fn status_to_string(status : @types.ItemStatus) -> String {
  match status {
    @types.ItemStatus::Normal => "normal"
    @types.ItemStatus::High => "high"
    @types.ItemStatus::Low => "low"
    @types.ItemStatus::Abnormal => "abnormal"
    @types.ItemStatus::Unknown => "unknown"
  }
}

pub fn format_html(result : @types.AnalysisResult) -> String {
  let mut html = "<!DOCTYPE html>\n"
  html = html + "<html lang=\"zh-CN\">\n"
  html = html + "<head>\n"
  html = html + "  <meta charset=\"UTF-8\">\n"
  html = html + "  <title>å¥åº·æŠ¥å‘Šè§£è¯»</title>\n"
  html = html + "  <style>\n"
  html = html + "    body { font-family: 'Microsoft YaHei', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }\n"
  html = html + "    .summary { background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }\n"
  html = html + "    .detail-item { border-left: 3px solid #3b82f6; padding-left: 15px; margin: 10px 0; }\n"
  html = html + "    .normal { border-left-color: #22c55e; }\n"
  html = html + "    .high { border-left-color: #ef4444; }\n"
  html = html + "    .low { border-left-color: #f59e0b; }\n"
  html = html + "    .warning { background: #fef3c7; padding: 10px; border-radius: 4px; margin: 5px 0; }\n"
  html = html + "    .recommendation { background: #dcfce7; padding: 10px; border-radius: 4px; margin: 5px 0; }\n"
  html = html + "    .disclaimer { color: #666; font-size: 12px; margin-top: 20px; padding: 10px; background: #f3f4f6; border-radius: 4px; }\n"
  html = html + "  </style>\n"
  html = html + "</head>\n"
  html = html + "<body>\n"
  html = html + "  <h1>å¥åº·æŠ¥å‘Šè§£è¯»</h1>\n"
  html = html + "  <div class=\"summary\">\n"
  html = html + "    <h2>æ•´ä½“è¯„ä¼°</h2>\n"
  html = html + "    <p>" + result.summary + "</p>\n"
  html = html + "  </div>\n"
  
  if result.details.length() > 0 {
    html = html + "  <h2>è¯¦ç»†æŒ‡æ ‡åˆ†æ</h2>\n"
    for item in result.details {
      let status_class = match item.status {
        @types.ItemStatus::Normal => "normal"
        @types.ItemStatus::High => "high"
        @types.ItemStatus::Low => "low"
        _ => ""
      }
      html = html + "  <div class=\"detail-item " + status_class + "\">\n"
      html = html + "    <strong>" + item.item_name + "</strong>\n"
      html = html + "    <p>æ£€æµ‹å€¼ï¼š" + item.value + " " + item.unit + "</p>\n"
      if !item.normal_range.is_empty() {
        html = html + "    <p>æ­£å¸¸èŒƒå›´ï¼š" + item.normal_range + "</p>\n"
      }
      if !item.explanation.is_empty() {
        html = html + "    <p>è§£è¯»ï¼š" + item.explanation + "</p>\n"
      }
      html = html + "  </div>\n"
    }
  }
  
  if result.warnings.length() > 0 {
    html = html + "  <h2>éœ€è¦å…³æ³¨çš„æŒ‡æ ‡</h2>\n"
    for warning in result.warnings {
      html = html + "  <div class=\"warning\">âš ï¸ " + warning + "</div>\n"
    }
  }
  
  if result.recommendations.length() > 0 {
    html = html + "  <h2>å»ºè®®</h2>\n"
    for rec in result.recommendations {
      html = html + "  <div class=\"recommendation\">ğŸ’¡ " + rec + "</div>\n"
    }
  }
  
  html = html + "  <div class=\"disclaimer\">\n"
  html = html + "    ğŸ“Œ é‡è¦æç¤ºï¼šæœ¬è§£è¯»ä»…ä¾›å‚è€ƒï¼Œä¸ä½œä¸ºåŒ»ç–—è¯Šæ–­ä¾æ®ã€‚å¦‚æœ‰å¥åº·é—®é¢˜ï¼Œè¯·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿã€‚\n"
  html = html + "  </div>\n"
  html = html + "</body>\n"
  html = html + "</html>"
  
  html
}

pub fn simplify_explanation(technical_text : String) -> String {
  let mut result = technical_text
  
  let replacements = [
    ("è¡€çº¢è›‹ç™½", "è¡€æ¶²ä¸­æºå¸¦æ°§æ°”çš„è›‹ç™½è´¨"),
    ("ç™½ç»†èƒ", "èº«ä½“çš„å…ç–«ç»†èƒï¼Œå¸®åŠ©æŠµæŠ—æ„ŸæŸ“"),
    ("è¡€å°æ¿", "å¸®åŠ©è¡€æ¶²å‡å›ºçš„ç»†èƒ"),
    ("è°·ä¸™è½¬æ°¨é…¶(ALT)", "è‚è„å¥åº·æŒ‡æ ‡"),
    ("è°·è‰è½¬æ°¨é…¶(AST)", "è‚è„å’Œå¿ƒè„å¥åº·æŒ‡æ ‡"),
    ("è‚Œé…", "è‚¾è„è¿‡æ»¤åŠŸèƒ½çš„æŒ‡æ ‡"),
    ("å°¿ç´ æ°®", "è‚¾è„å¥åº·çš„æŒ‡æ ‡"),
    ("ç©ºè…¹è¡€ç³–", "ç©ºè…¹æ—¶çš„è¡€ç³–æ°´å¹³"),
    ("ç”˜æ²¹ä¸‰é…¯", "è¡€æ¶²ä¸­çš„ä¸€ç§è„‚è‚ª"),
    ("æ€»èƒ†å›ºé†‡", "è¡€æ¶²ä¸­èƒ†å›ºé†‡çš„æ€»é‡"),
    ("çº¢ç»†èƒ", "è´Ÿè´£è¿è¾“æ°§æ°”çš„ç»†èƒ"),
    ("çº¢ç»†èƒå‹ç§¯", "çº¢ç»†èƒåœ¨è¡€æ¶²ä¸­æ‰€å çš„ä½“ç§¯æ¯”ä¾‹"),
    ("å°¿é…¸", "å˜Œå‘¤ä»£è°¢çš„äº§ç‰©"),
    ("ç³–åŒ–è¡€çº¢è›‹ç™½", "åæ˜ è¿‘2-3ä¸ªæœˆè¡€ç³–æ§åˆ¶æƒ…å†µ")
  ]
  
  for (term, explanation) in replacements {
    result = result.replace(term, term + "(" + explanation + ")")
  }
  
  result
}

pub fn generate_explanation(item_name : String, status : @types.ItemStatus) -> String {
  let status_text = match status {
    @types.ItemStatus::Normal => "å¤„äºæ­£å¸¸èŒƒå›´å†…"
    @types.ItemStatus::High => "é«˜äºæ­£å¸¸èŒƒå›´"
    @types.ItemStatus::Low => "ä½äºæ­£å¸¸èŒƒå›´"
    @types.ItemStatus::Abnormal => "å­˜åœ¨å¼‚å¸¸"
    @types.ItemStatus::Unknown => "çŠ¶æ€æœªçŸ¥"
  }
  
  let explanation = match item_name {
    "è¡€çº¢è›‹ç™½" => "è¡€çº¢è›‹ç™½æ˜¯è¡€æ¶²ä¸­è´Ÿè´£æºå¸¦æ°§æ°”çš„è›‹ç™½è´¨ã€‚" + status_text + "ã€‚"
    "ç™½ç»†èƒ" => "ç™½ç»†èƒæ˜¯èº«ä½“çš„å…ç–«ç»†èƒã€‚" + status_text + "ï¼Œå¯èƒ½å½±å“èº«ä½“æŠµæŠ—æ„ŸæŸ“çš„èƒ½åŠ›ã€‚"
    "è¡€å°æ¿" => "è¡€å°æ¿å‚ä¸è¡€æ¶²å‡å›ºã€‚" + status_text + "ï¼Œå¯èƒ½å½±å“æ­¢è¡€èƒ½åŠ›ã€‚"
    "çº¢ç»†èƒ" => "çº¢ç»†èƒè´Ÿè´£è¿è¾“æ°§æ°”ã€‚" + status_text + "ã€‚"
    "è‚Œé…" => "è‚Œé…æ˜¯è‚Œè‚‰ä»£è°¢çš„äº§ç‰©ï¼Œé€šè¿‡è‚¾è„æ’å‡ºã€‚" + status_text + "ï¼Œå¯èƒ½åæ˜ è‚¾è„åŠŸèƒ½çŠ¶æ€ã€‚"
    "å°¿ç´ æ°®" => "å°¿ç´ æ°®æ˜¯è›‹ç™½è´¨ä»£è°¢çš„äº§ç‰©ã€‚" + status_text + "ï¼Œå¯èƒ½ä¸è‚¾è„åŠŸèƒ½ç›¸å…³ã€‚"
    "å°¿é…¸" => "å°¿é…¸æ˜¯å˜Œå‘¤ä»£è°¢çš„äº§ç‰©ã€‚" + status_text + "ï¼Œè¿‡é«˜å¯èƒ½ä¸ç—›é£ç›¸å…³ã€‚"
    _ => item_name + status_text + "ã€‚"
  }
  
  explanation
}

pub fn count_abnormal_items(result : @types.AnalysisResult) -> Int {
  let mut count = 0
  for item in result.details {
    if item.is_abnormal() {
      count = count + 1
    }
  }
  count
}

pub fn get_overall_status(result : @types.AnalysisResult) -> String {
  let abnormal_count = count_abnormal_items(result)
  
  if abnormal_count == 0 {
    "å„é¡¹æŒ‡æ ‡å‡åœ¨æ­£å¸¸èŒƒå›´å†…"
  } else if abnormal_count == 1 {
    "æœ‰1é¡¹æŒ‡æ ‡å¼‚å¸¸"
  } else if abnormal_count <= 3 {
    "æœ‰" + abnormal_count.to_string() + "é¡¹æŒ‡æ ‡å¼‚å¸¸"
  } else {
    "å¤šé¡¹æŒ‡æ ‡å¼‚å¸¸ï¼Œå»ºè®®å°½å¿«å°±åŒ»"
  }
}

pub fn format_markdown(result : @types.AnalysisResult) -> String {
  let mut md = "# å¥åº·æŠ¥å‘Šè§£è¯»\n\n"
  
  md = md + "## æ•´ä½“è¯„ä¼°\n\n"
  md = md + result.summary + "\n\n"
  
  if result.details.length() > 0 {
    md = md + "## è¯¦ç»†æŒ‡æ ‡åˆ†æ\n\n"
    md = md + "| æŒ‡æ ‡ | æ£€æµ‹å€¼ | æ­£å¸¸èŒƒå›´ | çŠ¶æ€ |\n"
    md = md + "|------|--------|----------|------|\n"
    for item in result.details {
      let status_text = match item.status {
        @types.ItemStatus::Normal => "âœ… æ­£å¸¸"
        @types.ItemStatus::High => "â¬†ï¸ åé«˜"
        @types.ItemStatus::Low => "â¬‡ï¸ åä½"
        @types.ItemStatus::Abnormal => "âš ï¸ å¼‚å¸¸"
        @types.ItemStatus::Unknown => "â“ æœªçŸ¥"
      }
      md = md + "| " + item.item_name + " | " + item.value + " " + item.unit + " | " + item.normal_range + " | " + status_text + " |\n"
    }
    md = md + "\n"
  }
  
  if result.warnings.length() > 0 {
    md = md + "## éœ€è¦å…³æ³¨çš„æŒ‡æ ‡\n\n"
    for warning in result.warnings {
      md = md + "- âš ï¸ " + warning + "\n"
    }
    md = md + "\n"
  }
  
  if result.recommendations.length() > 0 {
    md = md + "## å»ºè®®\n\n"
    for rec in result.recommendations {
      md = md + "- ğŸ’¡ " + rec + "\n"
    }
    md = md + "\n"
  }
  
  md = md + "---\n\n"
  md = md + "*ğŸ“Œ é‡è¦æç¤ºï¼šæœ¬è§£è¯»ä»…ä¾›å‚è€ƒï¼Œä¸ä½œä¸ºåŒ»ç–—è¯Šæ–­ä¾æ®ã€‚å¦‚æœ‰å¥åº·é—®é¢˜ï¼Œè¯·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿã€‚*\n"
  
  md
}
